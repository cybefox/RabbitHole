<!-- <!DOCTYPE html>
<html>

<head>
  <title>Email Template Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>

<body class="p-4">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">PhishTracker</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="/generate">Generate</a></li>
          <li class="nav-item"><a class="nav-link" href="/users">Users</a></li>
          <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/report">Report</a></li>
          <li class="nav-item"><a class="nav-link" href="/import">Import</a></li>
          <li class="nav-item"><a class="nav-link active" href="/email-template">Email Template</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="/logout">Logout</a></li>
        </ul>
        <button class="btn btn-sm btn-outline-warning" onclick="resetAnalytics()">âŸ³ Reset Analytics</button>
      </div>
    </div>
  </nav>

  <h3>Email Template</h3>

  <!-- GROUP SELECTION 
  <form method="POST" id="groupForm">
    <div class="mb-3">
      <label for="group">Select Group:</label>
      <select name="group" onchange="this.form.submit()" class="form-select">
        <option disabled selected>Select Group</option>
        {% for g in groups %}
        <option value="{{ g }}" {% if g==selected_group %}selected{% endif %}>{{ g }}</option>
        {% endfor %}
      </select>
    </div>
  </form>

  {% if users %}
  <!-- MAIN FORM 
  <form method="POST" action="/send-emails">
    <input type="hidden" name="group" value="{{ selected_group }}">

    <div class="form-check mb-3">
      <input type="checkbox" id="selectAllCheckbox">
      <label class="form-check-label" for="selectAllCheckbox">Select All</label>
    </div>

    <!-- ðŸ“© Filter Email Status 
    <div class="mb-3">
      <label for="emailStatusFilter">Filter by Email Status:</label>
      <select id="emailStatusFilter" class="form-select">
        <option value="">All</option>
        <option value="sent">Sent</option>
        <option value="pending">Pending</option>
      </select>
    </div>


    <table id="userTable" class="display table table-bordered table-sm">
      <thead class="table-dark">
        <tr>
          <th>Select</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr data-status="{{ 'sent' if u.get('sent_count', 0)|int > 0 else 'pending' }}">
          <td><input type="checkbox" class="form-check-input" name="usernames" value="{{ u.username }}"></td>
          <td>{{ u.first_name }}</td>
          <td>{{ u.last_name }}</td>
          <td>{{ u.email }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h5>Email Template (HTML)</h5>
    <textarea name="template" class="form-control"
      rows="8">{{ template_text or "<p>Hello {{first_name}},<br>Click here: {{link}}</p>" }}</textarea>
    <br>

    <div class="my-3">
      <label>Delay between emails (in seconds):</label>
      <input type="number" name="delay" class="form-control" value="3">
    </div>

    <div class="d-flex gap-3">
      <button type="submit" name="action" value="generate" formaction="/email-template" class="btn btn-primary">ðŸ“‹
        Generate Emails</button>
      <button type="submit" name="action" value="send" formaction="/send-emails" class="btn btn-success">ðŸ“¨ Send Emails
        to Selected Users</button>
    </div>
  </form>
  {% endif %}

  {% if generated %}
  <hr>
  <h5>Generated Emails:</h5>
  {% for g in generated %}
  <div class="border p-2 mb-3 bg-light">
    <strong>{{ g.email }}</strong>
    <textarea class="form-control" rows="6">{{ g.body }}</textarea>
  </div>
  {% endfor %}
  {% endif %}

  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    function resetAnalytics() {
      if (confirm("Reset all analytics?")) {
        fetch('/reset-analytics', { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            alert("âœ… Analytics reset!");
            location.reload();
          });
      }
    }

    $(document).ready(function () {
      const table = $('#userTable').DataTable({
        "pageLength": 50,
        "lengthMenu": [10, 25, 50, 100, 200],
        "scrollY": "400px",
        "scrollCollapse": true,
        "paging": true,
        "ordering": true,
        "deferRender": true
      });

      // âœ… Select All Checkbox
      $('#selectAllCheckbox').on('change', function () {
        const checked = this.checked;
        $('#userTable tbody input[type="checkbox"]').each(function () {
          if ($(this).closest('tr').is(':visible')) {
            this.checked = checked;
          }
        });
      });

      // âœ… Custom Email Status Filter (DataTables filter extension)
      $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
        const selectedStatus = $('#emailStatusFilter').val();
        const row = $('#userTable tbody tr').eq(dataIndex);
        const rowStatus = row.attr('data-status');
        return !selectedStatus || rowStatus === selectedStatus;
      });

      // âœ… Redraw table on dropdown change
      $('#emailStatusFilter').on('change', function () {
        table.draw();
      });
    });
  </script>

</body>

</html> -->


<!DOCTYPE html>
<html>

<head>
  <title>Email Template Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>

<body class="p-4">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">PhishTracker</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="/generate">Generate</a></li>
          <li class="nav-item"><a class="nav-link" href="/users">Users</a></li>
          <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/report">Report</a></li>
          <li class="nav-item"><a class="nav-link" href="/import">Import</a></li>
          <li class="nav-item"><a class="nav-link active" href="/email-template">Email Template</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="/logout">Logout</a></li>
        </ul>
        <button class="btn btn-sm btn-outline-warning" onclick="resetAnalytics()">âŸ³ Reset Analytics</button>
      </div>
    </div>
  </nav>

  <h3>Email Template</h3>

  <!-- GROUP SELECTION -->
  <form method="POST" id="groupForm">
    <div class="mb-3">
      <label for="group">Select Group:</label>
      <select name="group" onchange="this.form.submit()" class="form-select">
        <option disabled selected>Select Group</option>
        {% for g in groups %}
        <option value="{{ g }}" {% if g==selected_group %}selected{% endif %}>{{ g }}</option>
        {% endfor %}
      </select>
    </div>
  </form>

  {% if users %}
  <!-- MAIN FORM -->
  <form method="POST" action="/send-emails">
    <input type="hidden" name="group" value="{{ selected_group }}">

    <div class="form-check mb-3">
      <input type="checkbox" id="selectAllCheckbox">
      <label class="form-check-label" for="selectAllCheckbox">Select All</label>
    </div>

    <!-- ðŸ“© Filter Email Status -->
    <div class="mb-3">
      <label for="emailStatusFilter">Filter by Email Status:</label>
      <select id="emailStatusFilter" class="form-select">
        <option value="">All</option>
        <option value="sent">Sent</option>
        <option value="pending">Pending</option>
      </select>
    </div>

    <table id="userTable" class="display table table-bordered table-sm">
      <thead class="table-dark">
        <tr>
          <th>Select</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr data-status="{{ 'sent' if u.sent_count|int > 0 else 'pending' }}">
          <td><input type="checkbox" class="form-check-input" name="usernames" value="{{ u.username }}"></td>
          <td>{{ u.first_name }}</td>
          <td>{{ u.last_name }}</td>
          <td>{{ u.email }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h5>Email Template (HTML)</h5>
    <textarea name="template" class="form-control"
      rows="8">{{ template_text or "<p>Hello {{first_name}},<br>Click here: {{link}}</p>" }}</textarea>
    <br>

    <div class="my-3">
      <label>Delay between emails (in seconds):</label>
      <input type="number" name="delay" class="form-control" value="3">
    </div>

    <div class="d-flex gap-3">
      <button type="submit" name="action" value="generate" formaction="/email-template" class="btn btn-primary">ðŸ“‹
        Generate Emails</button>
      <button type="submit" name="action" value="send" formaction="/send-emails" class="btn btn-success">ðŸ“¨ Send Emails
        to Selected Users</button>
    </div>
  </form>
  {% endif %}

  {% if generated %}
  <hr>
  <h5>Generated Emails:</h5>
  {% for g in generated %}
  <div class="border p-2 mb-3 bg-light">
    <strong>{{ g.email }}</strong>
    <textarea class="form-control" rows="6">{{ g.body }}</textarea>
  </div>
  {% endfor %}
  {% endif %}

  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    function resetAnalytics() {
      if (confirm("Reset all analytics?")) {
        fetch('/reset-analytics', { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            alert("âœ… Analytics reset!");
            location.reload();
          });
      }
    }

    $(document).ready(function () {
      const table = $('#userTable').DataTable({
        "pageLength": 50,
        "lengthMenu": [10, 25, 50, 100, 200],
        "scrollY": "400px",
        "scrollCollapse": true,
        "paging": true,
        "ordering": true,
        "deferRender": true
      });

      $('#selectAllCheckbox').on('change', function () {
        const checked = this.checked;
        $('#userTable tbody input[type="checkbox"]').each(function () {
          if ($(this).closest('tr').is(':visible')) {
            this.checked = checked;
          }
        });
      });

      // âœ… Email Sent Filter using DataTables custom search
      $.fn.dataTable.ext.search.push(function (settings, data, dataIndex, rowData, counter) {
        const selected = $('#emailStatusFilter').val();
        const row = table.row(dataIndex).node();
        const status = $(row).attr('data-status'); // Get the data-status attr

        if (!selected || selected === status) {
          return true;
        }
        return false;
      });

      $('#emailStatusFilter').on('change', function () {
        table.draw();
      });
    });
  </script>
</body>

</html>